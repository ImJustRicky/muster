# Muster — Universal Deploy Framework

## What It Is

A pure-bash, zero-dependency, modular deploy framework with a beautiful interactive TUI. Muster gives any project a polished deploy experience — interactive dashboard, health checks, rollback, log streaming — regardless of stack.

**Philosophy:** Muster handles orchestration and the experience. Your scripts handle the how.

## Commands

```
muster setup     →  guided wizard, writes deploy.json
muster           →  dashboard (live health/status + action menu)
muster deploy    →  deploy all or specific services
muster status    →  quick health check
muster logs      →  stream logs
muster rollback  →  revert last deploy
muster cleanup   →  cleanup stuck processes
muster skill     →  manage addon skills
```

All operations are defined by the framework, but if a project doesn't have a hook for one (e.g., no rollback script), it's silently skipped — no errors, no empty menu items.

## Architecture

### Framework Structure

```
muster/
├── bin/
│   └── muster                  ← entry point (routes commands)
├── lib/
│   ├── core/
│   │   ├── config.sh           ← read/write deploy.json
│   │   ├── colors.sh           ← colors, styling constants
│   │   ├── logger.sh           ← log, warn, err, ok, info
│   │   └── utils.sh            ← shared helpers
│   ├── tui/
│   │   ├── menu.sh             ← arrow-key interactive menu
│   │   ├── checklist.sh        ← toggle checklist (setup wizard)
│   │   ├── spinner.sh          ← spinners
│   │   ├── progress.sh         ← progress bars
│   │   ├── dashboard.sh        ← live health/status dashboard
│   │   └── streambox.sh        ← live-scrolling log box
│   ├── commands/
│   │   ├── setup.sh            ← guided setup wizard
│   │   ├── deploy.sh           ← deploy orchestration
│   │   ├── status.sh           ← health/status check
│   │   ├── logs.sh             ← log streaming
│   │   ├── rollback.sh         ← rollback logic
│   │   └── cleanup.sh          ← cleanup stuck processes
│   └── skills/
│       └── manager.sh          ← install, list, remove, run skills
├── templates/
│   └── deploy.example.json     ← example config for reference
├── install.sh                  ← curl | bash installer
├── LICENSE
└── README.md
```

### Per-Project Structure (generated by `muster setup`)

```
myproject/
├── deploy.json                 ← main config
└── .muster/
    ├── hooks/
    │   ├── api/
    │   │   ├── deploy.sh
    │   │   ├── health.sh
    │   │   └── rollback.sh
    │   └── redis/
    │       ├── deploy.sh
    │       └── health.sh
    └── logs/
```

## Config Format (deploy.json)

Clean, human-readable JSON. Generated by the setup wizard, editable anytime.

```json
{
  "project": "myapp",
  "version": "1",
  "root": "/home/deploy/myapp",
  "services": {
    "api": {
      "name": "API Server",
      "type": "docker",
      "port": 8080,
      "health": {
        "type": "http",
        "endpoint": "/health",
        "timeout": 10
      },
      "credentials": {
        "enabled": false,
        "risk_level": "high",
        "store": "keychain"
      },
      "depends_on": ["redis", "postgres"]
    },
    "redis": {
      "name": "Redis",
      "type": "docker",
      "port": 6379,
      "health": {
        "type": "tcp",
        "timeout": 5
      }
    },
    "postgres": {
      "name": "PostgreSQL",
      "type": "managed",
      "skip_deploy": true,
      "health": {
        "type": "tcp",
        "port": 5432,
        "timeout": 5
      }
    }
  },
  "deploy_order": ["redis", "api"],
  "skills": ["ssl", "notify"]
}
```

- `skip_deploy: true` for managed services (muster still health-checks them)
- `deploy_order` respects `depends_on` and ensures correct sequencing

## Credential Security

**Off by default. Flagged as high risk. Never in deploy.json or git.**

When a user opts in to storing credentials for a service:

1. **System keychain** if available (macOS Keychain, `secret-tool`, `pass`)
2. **Encrypted vault** fallback: `~/.muster/vault` (AES-256, passphrase-protected)

The vault lives in `~/.muster/`, NOT in the project directory. Config only records whether credentials are enabled, never the actual values.

Dashboard shows risk clearly:

```
  ┌─ Services ──────────────────────────────┐
  │  ● API Server       healthy    3m ago   │
  │  ● Redis            healthy    3m ago   │
  │  ● PostgreSQL       healthy  ⚠ KEY  3m  │
  └─────────────────────────────────────────┘
         ⚠ KEY = stored credentials (high risk)
```

## Setup Wizard (`muster setup`)

Interactive, conversational flow:

1. **Project root** — "Where is your project?" (default: parent directory). If path doesn't exist, don't auto-detect — ask manually.
2. **Conversational questions** — one at a time, multiple choice preferred:
   - "Do you manage a database here?"
   - "Do you have a web server or API?"
   - "Any background workers?"
   - "Do you use containers?"
3. **Scan & confirm** — scan the pointed directory for known files (Dockerfile, docker-compose.yml, k8s manifests, package.json, etc.) and propose findings
4. **Checklist** — present all detected/declared services with checkmarks, user toggles what they want
5. **Per-service config** — for each checked service, ask about health check type, deploy command, credentials
6. **Skills suggestion** — recommend relevant skills based on the stack
7. **Write config** — generate deploy.json, .muster/hooks/ scaffolding, update .gitignore

## Dashboard (`muster`)

Dashboard-first experience on every run after setup:

- Live health/status view showing all services
- Color-coded status (green healthy, yellow degraded, red down)
- Timestamps for last check
- Credential warnings (⚠ KEY)
- Action menu at the bottom (deploy, logs, rollback, etc.)
- Only shows operations that have hooks defined

## Skills System

Community-contributed addons. Installed to `~/.muster/skills/`.

```
~/.muster/skills/ssl/
  skill.json       ← name, description, version, hooks
  run.sh           ← logic
```

Commands:

```
muster skill add <git-url>
muster skill list
muster skill remove <name>
```

Setup wizard suggests relevant skills based on detected stack.

## Plugin Model

Muster delegates all stack-specific work to hook scripts in `.muster/hooks/<service>/`. The framework doesn't know how to deploy a Go app or restart Redis — it runs your scripts, shows the output beautifully, and verifies health afterward.

This means every deployment target is automatically supported (AWS, GCP, k8s, bare metal, Docker, whatever) as long as someone writes the hook scripts.

## TUI Components (from Waity deploy script inspiration)

- Arrow-key interactive menus
- Toggle checklists
- Braille spinners
- Color-coded progress bars
- Live-scrolling log boxes with borders
- Box-drawn headers and dividers
- Terminal-responsive sizing
