# Muster

> Universal deploy framework. Pure bash, zero dependencies, modular TUI. Orchestrates deploy/health/rollback by running user-provided hook scripts with beautiful terminal output.

Muster is a CLI tool (`bin/muster`) that gives any project a polished deploy experience — interactive dashboard, health checks, rollback, log streaming — regardless of stack. It doesn't deploy your app. It runs your scripts beautifully and verifies everything works.

- Language: Bash (3.2+ compatible, macOS/Linux)
- Config: `deploy.json` at project root
- Hooks: `.muster/hooks/<service>/deploy.sh|health.sh|rollback.sh|logs.sh|cleanup.sh`
- Skills: community addons in `~/.muster/skills/`
- No external dependencies required (uses jq or python3 for JSON if available)

## Architecture

```
muster/
├── bin/muster                     ← entry point, command router
├── bin/muster-mcp                 ← MCP stdio transport (LLM integration)
├── lib/
│   ├── core/
│   │   ├── colors.sh              ← ANSI color constants
│   │   ├── config.sh              ← deploy.json + ~/.muster/settings.json reader/writer
│   │   ├── credentials.sh         ← credential storage (keychain/session/prompt)
│   │   ├── logger.sh              ← log/warn/err/ok/info functions
│   │   ├── platform.sh            ← OS/arch/tool detection
│   │   ├── scanner.sh             ← project file/service/stack detection (subdirs, .musterignore)
│   │   └── utils.sh               ← terminal size, WINCH trap, Ctrl+C guard, helpers
│   ├── tui/
│   │   ├── menu.sh                ← arrow-key interactive menu
│   │   ├── checklist.sh           ← toggle checklist with box
│   │   ├── order.sh               ← reorderable list (grab/drop/move)
│   │   ├── spinner.sh             ← braille spinner
│   │   ├── progress.sh            ← color-coded progress bar
│   │   ├── streambox.sh           ← live-scrolling log box
│   │   └── dashboard.sh           ← main dashboard view (loops)
│   ├── commands/
│   │   ├── setup.sh               ← scan-first guided wizard
│   │   ├── deploy.sh              ← deploy orchestration
│   │   ├── status.sh              ← service health check
│   │   ├── logs.sh                ← log streaming
│   │   ├── rollback.sh            ← rollback services
│   │   ├── cleanup.sh             ← cleanup processes/logs
│   │   ├── settings.sh            ← project settings + global muster settings
│   │   └── uninstall.sh           ← remove muster from project
│   └── skills/
│       └── manager.sh             ← skill add/remove/list/run
├── templates/
│   ├── deploy.example.json        ← example config
│   └── hooks/                     ← stack-specific hook templates
│       ├── k8s/                   ← kubectl apply, set image, rollout, logs
│       │   └── infra/            ← infrastructure variant (pull-only, no build)
│       ├── compose/               ← docker compose build, up, down, logs
│       │   └── infra/            ← infrastructure variant (pull-only)
│       ├── docker/                ← docker build, run, stop, logs
│       │   └── infra/            ← infrastructure variant (pull-only)
│       └── bare/                  ← git pull, make, systemctl, journalctl
├── install.sh                     ← curl | bash installer
├── LICENSE
└── README.md
```

Per-project structure (generated by `muster setup`):

```
your-project/
├── deploy.json                    ← main config
└── .muster/
    ├── hooks/
    │   ├── api/
    │   │   ├── deploy.sh          ← real deploy logic from stack template
    │   │   ├── health.sh          ← real health check
    │   │   ├── rollback.sh        ← real rollback logic
    │   │   ├── logs.sh            ← log streaming
    │   │   └── cleanup.sh         ← cleanup stale resources
    │   └── redis/
    │       ├── deploy.sh
    │       ├── health.sh
    │       └── ...
    └── logs/                      ← deploy logs (gitignored)
```

## Commands

| Command | Description |
|---------|-------------|
| `muster` | Dashboard — live health/status view with action menu (loops) |
| `muster setup` | Interactive setup wizard, or non-interactive with flags (`--help`) |
| `muster deploy` | Deploy all services (respects deploy order) |
| `muster deploy <svc>` | Deploy a specific service |
| `muster status` | Check health of all services |
| `muster logs [svc]` | Stream logs (interactive picker if no arg) |
| `muster rollback [svc]` | Rollback a service |
| `muster cleanup` | Clean up stuck processes and old logs |
| `muster settings` | Project settings + global muster preferences |
| `muster settings --global [key] [value]` | View/edit global settings (color, log retention, etc.) |
| `muster uninstall` | Remove muster from project (with confirmation) |
| `muster skill add <url>` | Install a skill addon |
| `muster skill list` | List installed skills |
| `muster skill remove <name>` | Remove a skill |
| `muster skill run <name>` | Execute a skill |

## Config Format (deploy.json)

```json
{
  "project": "myapp",
  "version": "1",
  "root": "/path/to/project",
  "services": {
    "api": {
      "name": "API Server",
      "health": {
        "type": "http",
        "endpoint": "/health",
        "port": 8080,
        "timeout": 10,
        "enabled": true
      },
      "credentials": {
        "mode": "off"
      },
      "skip_deploy": false
    },
    "redis": {
      "name": "Redis",
      "health": {
        "type": "tcp",
        "port": 6379,
        "timeout": 5,
        "enabled": true
      },
      "credentials": {
        "mode": "off"
      }
    }
  },
  "deploy_order": ["redis", "api"],
  "skills": []
}
```

Service keys (e.g. `api`, `redis`) map to hook directories at `.muster/hooks/<key>/`. Health types: `http`, `tcp`, `command`; disabled via `"enabled": false`. Services with `skip_deploy: true` are health-checked but not deployed. Credential modes: `off` (none), `save` (macOS Keychain), `session` (in-memory for current session), `always` (prompt every time) — actual credentials never stored in deploy.json or git.

## Entry Point: bin/muster

Resolves symlinks at startup (installer symlinks `~/.local/bin/muster` → `~/.muster/repo/bin/muster`). Routes commands via `case` statement. Loads core libs at startup: colors.sh, logger.sh, utils.sh, config.sh, platform.sh. Each command sources its module on demand. Exit trap runs `cleanup_term` (restores cursor, resets ANSI, restores stty echo).

Key globals set at startup:
- `MUSTER_VERSION="0.1.0"`
- `MUSTER_ROOT` — path to muster repo
- `TERM_COLS`/`TERM_ROWS` — updated on SIGWINCH
- `MUSTER_OS`/`MUSTER_ARCH` — from platform.sh
- `MUSTER_HAS_DOCKER`/`MUSTER_HAS_JQ`/etc — tool availability booleans

## Core Libraries

### config.sh

- `load_config()` — finds deploy.json by walking up from cwd, sets `CONFIG_FILE`
- `config_get(query)` — reads JSON value via `jq -r` or python3 fallback
- `config_set(path, value)` — writes individual JSON value via jq
- `config_services()` — returns service key names (one per line)
- `config_write(target)` — writes stdin to target file
- `_jq_quote(query)` — converts `.services.my-svc.name` to `.services["my-svc"].name` for jq safety with hyphenated keys
- `global_config_get(key)` — reads from `~/.muster/settings.json`
- `global_config_set(key, value)` — writes to `~/.muster/settings.json`
- `global_config_dump()` — prints all global settings as JSON
- `_ensure_global_config()` — creates settings file with defaults on first use

### scanner.sh

- `scan_project(dir)` — scans directory for deploy-relevant files and services
- Scans root + subdirectories: `docker/`, `deploy/`, `infra/`, `.github/`
- Sets `_SCAN_FILES[]` — `"filename|description"` entries
- Sets `_SCAN_SERVICES[]` — detected service names (from k8s subdirs, compose YAML, Dockerfile suffixes, config hints)
- Sets `_SCAN_STACK` — detected stack: `k8s`, `compose`, `docker`, `bare`, or empty
- Sets `_SCAN_PATHS[]` — `"service|type|relative_path"` entries for template generation
- `scan_get_path(svc, type)` — look up detected path (e.g., `scan_get_path "api" "dockerfile"`)
- `scan_get_compose_file()` — returns detected compose file path
- `_scan_add_service(name)` — deduplicating service registration
- `scan_print_results()` — pretty-prints detected files and stack
- Service hints: whole-word grep (`-w` flag) for redis, postgres, mongo, etc. — avoids false positives like "mongoose"
- Exclusion: `_SCAN_EXCLUDES` (space-separated), `.musterignore` file (one pattern per line), auto-skips `archived/deprecated/old/backup` dirs. Global `scanner_exclude` from settings is prepended.
- Stack priority: k8s > compose > docker > bare

### credentials.sh

- `cred_env_for_service(svc)` — main function, returns `MUSTER_CRED_KEY=value` lines
- Three modes controlled by `credentials.mode` in deploy.json:
  - `save` — macOS Keychain via `security add-generic-password`/`find-generic-password`
  - `session` — in-memory parallel arrays (`_CRED_KEYS[]`, `_CRED_VALS[]`)
  - `always` — prompts every time with hidden input (`stty -echo`)
- `_cred_prompt_password()` — hidden input prompt
- Deploy/rollback commands export `MUSTER_CRED_*` env vars before running hooks, unset after

### utils.sh

- `update_term_size()` — sets `TERM_COLS`/`TERM_ROWS` via `tput`
- `MUSTER_REDRAW_FN` — global callback name, invoked on SIGWINCH
- `_MUSTER_INPUT_DIRTY` — flag for menu/checklist resize handling
- `cleanup_term()` — EXIT trap: reset scroll region, show cursor, reset colors, restore echo
- Double Ctrl+C guard — first press warns, second within 5s exits, after 5s resets
- `has_cmd(name)` — checks `command -v`
- `find_config()` — walks up directories looking for deploy.json

### colors.sh

ANSI 256-color constants. Brand color: mustard (`\033[38;5;178m`). Aliases: `ACCENT=$MUSTARD`, `ACCENT_BRIGHT=$MUSTARD_BRIGHT`. All TUI components use these variables, never hardcoded escape codes. Reads `color_mode` from `~/.muster/settings.json` at source time: `never` clears all color vars, `always` forces colors, `auto` disables on non-TTY.

### logger.sh

Five output functions, each with colored prefix icon:
- `log()` — green `>`
- `warn()` — yellow `!`
- `err()` — red `x`
- `ok()` — green `*`
- `info()` — accent `i`

### platform.sh

Runs `detect_platform` at source time. Sets:
- `MUSTER_OS` — macos, linux, windows, freebsd, unknown
- `MUSTER_ARCH` — x64, arm64, armv7, or raw `uname -m`
- `MUSTER_HAS_KEYCHAIN` — true if macOS `security` or Linux `secret-tool`/`pass`
- `MUSTER_HAS_DOCKER`/`MUSTER_HAS_KUBECTL`/`MUSTER_HAS_JQ`/`MUSTER_HAS_PYTHON`

## TUI Components

### menu.sh — Interactive Menu

```bash
menu_select "title" "option1" "option2" "option3"
# Result in: $MENU_RESULT
```

Arrow keys navigate, Enter selects. On selection, collapses to single line showing choice. Uses `tput cuu1` + `tput ed` to redraw in-place (no cursor save/restore — unreliable on macOS Terminal). Handles SIGWINCH via `_MUSTER_INPUT_DIRTY` flag checked after each keypress.

Key internals:
- `_menu_read_key()` — reads 1 byte, detects ESC sequences (3 bytes for arrow keys)
- `_menu_draw()` / `_menu_clear()` — render/erase menu lines
- `tput civis` on entry, `tput cnorm` on exit (hide/show cursor)

### checklist.sh — Toggle Checklist

```bash
checklist_select "title" "item1" "item2" "item3"
# Result in: $CHECKLIST_RESULT (newline-separated checked items)
```

Box-drawn with `┌─┐│└─┘` borders. Space toggles `[✓]`/`[ ]`, Enter confirms. All items checked by default. Width: `TERM_COLS - 4`, max 50, min 10. Labels auto-truncate with `...`. Padding uses `printf '%*s'` (not `printf "%-Ns"` which breaks with ANSI).

### order.sh — Reorderable List

```bash
order_select "title" "item1" "item2" "item3"
# Result in: $ORDER_RESULT[@] (reordered array)
```

Arrow keys navigate, Enter grabs/drops an item, arrows move grabbed item up/down, `q` confirms. Box-drawn with borders. Grabbed items highlighted with accent color and `*` prefix. Used in setup wizard for deploy order.

### spinner.sh — Braille Spinner

```bash
start_spinner "Loading..."
# ... do work ...
stop_spinner
```

Runs in background subshell (`&` + `disown`). Braille frames: `⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏`. `stop_spinner` kills the subshell and clears the line with `\r\033[K`.

### progress.sh — Progress Bar

```bash
progress_bar 3 10 "Deploying..."  # 30%, yellow
```

Uses `#` for filled, `-` for empty (not `█`/`░` which are double-width in some terminals). Color: red (<33%), yellow (33-66%), green (>66%). Width: `TERM_COLS - 20`, max 50, min 10.

### streambox.sh — Live Log Box

```bash
stream_in_box "Title" "/path/to/logfile" command arg1 arg2
```

Draws a titled box with 4 visible lines. Runs command in background, redirects output to logfile. Refreshes box content every 0.3s by tailing the last 4 lines of the logfile. Strips ANSI codes from log content for clean display. Returns command's exit code.

### dashboard.sh — Main Dashboard

Requires TTY (errors cleanly on non-interactive stdin). Runs in a `while true` loop. Shows project info, platform details, service health box (green/red/gray dots), credential warnings (`! KEY`), and an action menu. Only shows actions that have corresponding hooks (e.g., Rollback only appears if any service has `rollback.sh`). Scans `~/.muster/skills/` and appends installed skills as "Skill: <name>" menu items. Includes Settings and Quit options. Pauses after each action ("Press any key to continue...") except interactive ones (logs, settings).

### settings.sh — Interactive Settings

Two sections: Project Settings and Muster Settings.

**Project Settings** — Cycle-style toggle widget (`_toggle_select`). Per-service options:
- Skip deploy: `OFF|ON`
- Health check: `ON|OFF`
- Credentials: `Off|Save always|Once per session|Every time`

Uses pipe-separated option strings for cycling. Saves changes to deploy.json via `config_set()`. Also provides "Open config" which opens Finder (macOS), xdg-open (Linux), or prints path (headless).

**Muster Settings** — Global preferences in `~/.muster/settings.json`:
- `color_mode`: auto/always/never (toggle)
- `log_retention_days`: number (text prompt)
- `default_stack`: bare/docker/compose/k8s (toggle)
- `default_health_timeout`: seconds (text prompt)
- `scanner_exclude`: patterns (add/remove)
- `update_check`: on/off (toggle)

**Non-interactive:** `muster settings --global [key] [value]`. No args dumps JSON. `scanner_exclude add|remove <patterns>` for array manipulation.

## Setup Wizard (setup.sh)

Two modes: interactive TUI wizard or non-interactive flag-based.

### Interactive (no flags)

Scan-first 7-step TUI flow:

1. **Project location** — path input with platform info display
2. **Scan project** — runs `scanner.sh` on the project directory, displays detected files/services/stack
3. **Confirm stack + select services** — confirms detected stack (or manual override), checklist of detected services (or manual entry if none found)
4. **Deploy order** — reorderable list (`order.sh`) to set service deploy sequence
5. **Per-service config** — health check type (HTTP/TCP/Command/None) + credential mode (None/Save/Session/Always)
6. **Project name** — confirm or customize
7. **Generate** — copies stack-specific hook templates from `templates/hooks/{k8s,compose,docker,bare}/`, replaces `{{SERVICE_NAME}}`, `{{NAMESPACE}}`, `{{PORT}}`, `{{COMPOSE_FILE}}` placeholders, writes deploy.json, updates .gitignore, shows completion summary

Falls back to manual conversational flow (database? API? workers? proxy? containers?) if scanner detects nothing.

### Non-interactive (flags)

Any flag triggers non-interactive mode — no TUI, plain text output only. Flags:

| Flag | Short | Description | Default |
|------|-------|-------------|---------|
| `--path <dir>` | `-p` | Project directory | `.` (cwd) |
| `--scan` | | Auto-detect stack, services from project files | off |
| `--stack <type>` | `-s` | Stack: `k8s`, `compose`, `docker`, `bare` | auto-detect if `--scan`, else `bare` |
| `--services <list>` | | Comma-separated service names | from scan, or required |
| `--order <list>` | | Comma-separated deploy order | same as `--services` order |
| `--health <spec>` | | Per-service: `svc=type[:endpoint:port]` (repeatable) | `none` for all |
| `--creds <spec>` | | Per-service: `svc=mode` (repeatable) | `off` for all |
| `--name <name>` | `-n` | Project name | directory basename |
| `--force` | `-f` | Overwrite existing deploy.json | off |
| `--help` | `-h` | Show usage and examples | |

Health spec format: `api=http:/health:8080`, `redis=tcp:6379`, `worker=command:./check.sh`, `api=none`. Credential modes: `off`, `save`, `session`, `always`.

`--scan` can combine with explicit flags — explicit values override scan results. Without `--scan`, `--services` is required. If deploy.json already exists, `--force` is required to overwrite. Interactive mode shows an "Overwrite/Cancel" menu instead. Non-TTY stdin errors with a suggestion to use `--scan` or `--help`.

Banner box: drawn with `printf '%b'` (not `echo -e`) to handle ANSI codes correctly. Progress bar in banner uses `#`/`-` chars. Phrase/tagline set once per session via `_SETUP_SESSION_PHRASE`. WINCH redraw only during `read` prompts (not during menus — `read -rsn1` not interrupted by SIGWINCH on bash 3.2).

## Deploy Flow (deploy.sh)

1. Load config, determine target (all or specific service)
2. For each service in `deploy_order`:
   a. Show progress bar
   b. Gather credentials via `cred_env_for_service()`, export as `MUSTER_CRED_*`
   c. Run `deploy.sh` hook inside `stream_in_box` (live log output)
   d. Unset `MUSTER_CRED_*` env vars
   e. If deploy succeeds and `health.enabled` is true, run `health.sh` with spinner
   f. If health fails: menu offers "Continue anyway" / "Rollback" / "Abort"
   g. Rollback runs `rollback.sh` hook if available
3. Show "Deploy complete" on success

## Hook Templates

`templates/hooks/` contains 35 template files: 20 application templates (4 stacks × 5 hooks) + 15 infrastructure templates (3 stacks × 5 hooks in `{k8s,compose,docker}/infra/`):

**Application templates** (build + deploy):
- **k8s/** — `docker build`, `docker push`, `kubectl apply`, `kubectl set image`, `kubectl rollout status/undo`, `kubectl logs`, `kubectl delete` failed pods
- **compose/** — `docker compose build`, `docker compose up -d`, `docker compose down`, `docker compose logs -f`, `docker compose rm`
- **docker/** — `docker build`, `docker run -d`, `docker stop/rm`, `docker logs -f`, `docker image prune`
- **bare/** — `git pull`, build command, `systemctl restart`, `journalctl -f`, `journalctl --vacuum-time`

**Infrastructure templates** (pull-only, no build — for redis, postgres, etc.):
- **k8s/infra/** — `kubectl set image` with pre-built `{{SERVICE_IMAGE}}`, no docker build/push
- **compose/infra/** — `docker compose pull` instead of build
- **docker/infra/** — `docker pull {{SERVICE_IMAGE}}` instead of build

Setup auto-selects infrastructure templates for known services (redis, postgres, mysql, mongo, rabbitmq, kafka, elasticsearch, nginx, memcached, etc.).

Each template uses `{{PLACEHOLDER}}` markers replaced during setup:
- `{{SERVICE_NAME}}` — service name
- `{{NAMESPACE}}` — k8s namespace (defaults to `default`)
- `{{PORT}}` — service port (defaults to `8080`)
- `{{COMPOSE_FILE}}` — compose file name (defaults to `docker-compose.yml`)
- `{{DOCKERFILE}}` — path to Dockerfile (from scanner, e.g., `docker/Dockerfile.api`)
- `{{K8S_DIR}}` — path to k8s manifests (from scanner, e.g., `k8s/api/`)
- `{{SERVICE_IMAGE}}` — pre-built image reference (e.g., `redis:7-alpine`)

## Skills System

Skills are addons installed to `~/.muster/skills/<name>/`. Structure:

```
skill-name/
├── skill.json   ← {"name", "version", "description", "author", "hooks", "requires"}
└── run.sh       ← executable entry point
```

Environment variables passed to run.sh: `MUSTER_PROJECT_DIR`, `MUSTER_CONFIG_FILE`, `MUSTER_SERVICE`, `MUSTER_HOOK`.

Install: `muster skill add <git-url-or-local-path>` — git URLs are cloned, `muster-skill-` prefix stripped. Local paths are copied and the `name` field from `skill.json` is used as the install name (falls back to directory basename). Validates `skill.json` exists.

Installed skills appear automatically in the dashboard Actions menu as "Skill: <name>".

Naming convention: `muster-skill-<name>` for GitHub repos.

## MCP Integration (bin/muster-mcp)

Pure bash MCP stdio transport. Lets LLMs call muster operations via the Model Context Protocol. Requires `jq`.

Runs as a local process — reads JSON-RPC from stdin, writes responses to stdout. Not a network server. Supports JSON-RPC batch arrays (dispatches each element individually). Uses shared `scan_project()` from `scanner.sh` for project detection (not a separate implementation). `scan_project` response includes a `paths` object mapping services to detected file paths.

### Configuration

Claude Desktop (`~/Library/Application Support/Claude/claude_desktop_config.json`):
```json
{ "mcpServers": { "muster": { "command": "muster-mcp" } } }
```

### Available Tools

**Setup & scaffolding (create projects from scratch):**

| Tool | Args | Description |
|------|------|-------------|
| `muster_scan_project` | `project_dir` | Detect Dockerfile, package.json, docker-compose, .env, etc. Suggests services. |
| `muster_init_project` | `project_dir`, `config` | Create deploy.json, hook dirs, .gitignore. `config` is full JSON string. |
| `muster_write_hook` | `project_dir`, `service`, `hook`, `content` | Write a hook script. `hook`: deploy.sh, health.sh, rollback.sh, logs.sh, cleanup.sh. Auto-creates dirs, sets executable. |
| `muster_read_hook` | `project_dir`, `service`, `hook` | Read hook contents. Shows existing hooks if requested one is missing. |

**Operations (manage running services):**

| Tool | Args | Description |
|------|------|-------------|
| `muster_list_services` | `project_dir` | List services with health type and hook availability |
| `muster_status` | `project_dir` | Health check all services (HEALTHY/UNHEALTHY) |
| `muster_deploy` | `project_dir`, `service?` | Deploy all or specific service, verify health |
| `muster_rollback` | `project_dir`, `service` | Rollback a service |
| `muster_logs` | `project_dir`, `service`, `lines?` | Get recent deploy log lines |
| `muster_cleanup` | `project_dir` | Run cleanup hooks, delete old logs |
| `muster_config` | `project_dir` | Return full deploy.json contents |

All tools require `project_dir`. Output is plain text (no ANSI codes).

### Typical LLM workflow

1. `muster_scan_project` — detect what's in the project
2. `muster_init_project` — create deploy.json with services
3. `muster_write_hook` — write deploy.sh, health.sh, rollback.sh for each service
4. `muster_deploy` — deploy everything
5. `muster_status` — verify health

### Protocol

Implements MCP protocol version `2024-11-05` over stdio. Handles: `initialize`, `notifications/initialized`, `tools/list`, `tools/call`, `ping`. Overrides the utils.sh EXIT trap to prevent ANSI leaking to stdout.

## Bash 3.2 Compatibility Notes

macOS ships bash 3.2. Key constraints:
- No `local -a` for array declaration (use `local arr=()`)
- No namerefs (`local -n`)
- No fractional `read -t` timeout (`-t 0.1` fails, use `-t 1` or `-t 0`)
- No `${var,,}` lowercase — use `tr '[:upper:]' '[:lower:]'`
- `tput sc`/`tput rc` cursor save/restore unreliable — use `tput cuu1` + `tput ed`
- SIGWINCH does NOT interrupt `read -rsn1` — menu redraws must happen after keypress
- `printf '%b'` for ANSI expansion (not `echo -e` when mixing raw escape bytes)
- `printf "%-Ns"` counts ANSI bytes as visible width — compute padding separately with `printf '%*s'`
- Array append: `arr[${#arr[@]}]=value` (not `arr+=()`)
