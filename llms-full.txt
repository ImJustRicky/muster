# Muster

> Universal deploy framework. Pure bash, zero dependencies, modular TUI. Orchestrates deploy/health/rollback by running user-provided hook scripts with beautiful terminal output.

Muster is a CLI tool (`bin/muster`) that gives any project a polished deploy experience — interactive dashboard, health checks, rollback, log streaming — regardless of stack. It doesn't deploy your app. It runs your scripts beautifully and verifies everything works.

- Language: Bash (3.2+ compatible, macOS/Linux)
- Config: `deploy.json` at project root
- Hooks: `.muster/hooks/<service>/deploy.sh|health.sh|rollback.sh`
- Skills: community addons in `~/.muster/skills/`
- No external dependencies required (uses jq or python3 for JSON if available)

## Architecture

```
muster/
├── bin/muster                     ← entry point, command router
├── bin/muster-mcp                 ← MCP stdio transport (LLM integration)
├── lib/
│   ├── core/
│   │   ├── colors.sh              ← ANSI color constants
│   │   ├── config.sh              ← deploy.json reader (jq/python3)
│   │   ├── logger.sh              ← log/warn/err/ok/info functions
│   │   ├── platform.sh            ← OS/arch/tool detection
│   │   └── utils.sh               ← terminal size, WINCH trap, helpers
│   ├── tui/
│   │   ├── menu.sh                ← arrow-key interactive menu
│   │   ├── checklist.sh           ← toggle checklist with box
│   │   ├── spinner.sh             ← braille spinner
│   │   ├── progress.sh            ← color-coded progress bar
│   │   ├── streambox.sh           ← live-scrolling log box
│   │   └── dashboard.sh           ← main dashboard view
│   ├── commands/
│   │   ├── setup.sh               ← 7-step guided wizard
│   │   ├── deploy.sh              ← deploy orchestration
│   │   ├── status.sh              ← service health check
│   │   ├── logs.sh                ← log streaming
│   │   ├── rollback.sh            ← rollback services
│   │   ├── cleanup.sh             ← cleanup processes/logs
│   │   └── uninstall.sh           ← remove muster from project
│   └── skills/
│       └── manager.sh             ← skill add/remove/list/run
├── templates/deploy.example.json  ← example config
├── install.sh                     ← curl | bash installer
└── docs/skills.md                 ← skill authoring guide
```

Per-project structure (generated by `muster setup`):

```
your-project/
├── deploy.json                    ← main config
└── .muster/
    ├── hooks/
    │   ├── api/
    │   │   ├── deploy.sh          ← user's deploy logic
    │   │   ├── health.sh          ← exit 0=healthy, 1=unhealthy
    │   │   ├── rollback.sh        ← optional rollback logic
    │   │   ├── logs.sh            ← optional log streaming
    │   │   └── cleanup.sh         ← optional cleanup
    │   └── redis/
    │       ├── deploy.sh
    │       └── health.sh
    └── logs/                      ← deploy logs (gitignored)
```

## Commands

| Command | Description |
|---------|-------------|
| `muster` | Dashboard — live health/status view with action menu |
| `muster setup` | Guided setup wizard |
| `muster deploy` | Deploy all services (respects deploy order) |
| `muster deploy <svc>` | Deploy a specific service |
| `muster status` | Check health of all services |
| `muster logs [svc]` | Stream logs (interactive picker if no arg) |
| `muster rollback [svc]` | Rollback a service |
| `muster cleanup` | Clean up stuck processes and old logs |
| `muster uninstall` | Remove muster from project (with confirmation) |
| `muster skill add <url>` | Install a skill addon |
| `muster skill list` | List installed skills |
| `muster skill remove <name>` | Remove a skill |
| `muster skill run <name>` | Execute a skill |

## Config Format (deploy.json)

```json
{
  "project": "myapp",
  "version": "1",
  "root": "/path/to/project",
  "services": {
    "api": {
      "name": "API Server",
      "health": {
        "type": "http",
        "endpoint": "/health",
        "port": 8080,
        "timeout": 10
      },
      "credentials": {
        "enabled": false,
        "risk_level": "high"
      },
      "skip_deploy": false
    },
    "redis": {
      "name": "Redis",
      "health": {
        "type": "tcp",
        "port": 6379,
        "timeout": 5
      }
    }
  },
  "deploy_order": ["redis", "api"],
  "skills": []
}
```

Service keys (e.g. `api`, `redis`) map to hook directories at `.muster/hooks/<key>/`. Health types: `http`, `tcp`, `command`, `null`. Services with `skip_deploy: true` are health-checked but not deployed. Credential storage: system keychain (macOS/Linux) or encrypted vault at `~/.muster/vault` — never in deploy.json or git.

## Entry Point: bin/muster

Routes commands via `case` statement. Loads core libs at startup: colors.sh, logger.sh, utils.sh, config.sh, platform.sh. Each command sources its module on demand. Exit trap runs `cleanup_term` (restores cursor, resets ANSI, restores stty echo).

Key globals set at startup:
- `MUSTER_VERSION="0.1.0"`
- `MUSTER_ROOT` — path to muster repo
- `TERM_COLS`/`TERM_ROWS` — updated on SIGWINCH
- `MUSTER_OS`/`MUSTER_ARCH` — from platform.sh
- `MUSTER_HAS_DOCKER`/`MUSTER_HAS_JQ`/etc — tool availability booleans

## Core Libraries

### config.sh

- `load_config()` — finds deploy.json by walking up from cwd, sets `CONFIG_FILE`
- `config_get(query)` — reads JSON value via `jq -r` or python3 fallback
- `config_services()` — returns service key names (one per line)
- `config_write(target)` — writes stdin to target file

### utils.sh

- `update_term_size()` — sets `TERM_COLS`/`TERM_ROWS` via `tput`
- `MUSTER_REDRAW_FN` — global callback name, invoked on SIGWINCH
- `_MUSTER_INPUT_DIRTY` — flag for menu/checklist resize handling
- `cleanup_term()` — EXIT trap: reset scroll region, show cursor, reset colors, restore echo
- `has_cmd(name)` — checks `command -v`
- `find_config()` — walks up directories looking for deploy.json

### colors.sh

ANSI 256-color constants. Brand color: mustard (`\033[38;5;178m`). Aliases: `ACCENT=$MUSTARD`, `ACCENT_BRIGHT=$MUSTARD_BRIGHT`. All TUI components use these variables, never hardcoded escape codes.

### logger.sh

Five output functions, each with colored prefix icon:
- `log()` — green `>`
- `warn()` — yellow `!`
- `err()` — red `x`
- `ok()` — green `*`
- `info()` — accent `i`

### platform.sh

Runs `detect_platform` at source time. Sets:
- `MUSTER_OS` — macos, linux, windows, freebsd, unknown
- `MUSTER_ARCH` — x64, arm64, armv7, or raw `uname -m`
- `MUSTER_HAS_KEYCHAIN` — true if macOS `security` or Linux `secret-tool`/`pass`
- `MUSTER_HAS_DOCKER`/`MUSTER_HAS_KUBECTL`/`MUSTER_HAS_JQ`/`MUSTER_HAS_PYTHON`

## TUI Components

### menu.sh — Interactive Menu

```bash
menu_select "title" "option1" "option2" "option3"
# Result in: $MENU_RESULT
```

Arrow keys navigate, Enter selects. On selection, collapses to single line showing choice. Uses `tput cuu1` + `tput ed` to redraw in-place (no cursor save/restore — unreliable on macOS Terminal). Handles SIGWINCH via `_MUSTER_INPUT_DIRTY` flag checked after each keypress.

Key internals:
- `_menu_read_key()` — reads 1 byte, detects ESC sequences (3 bytes for arrow keys)
- `_menu_draw()` / `_menu_clear()` — render/erase menu lines
- `tput civis` on entry, `tput cnorm` on exit (hide/show cursor)

### checklist.sh — Toggle Checklist

```bash
checklist_select "title" "item1" "item2" "item3"
# Result in: $CHECKLIST_RESULT (newline-separated checked items)
```

Box-drawn with `┌─┐│└─┘` borders. Space toggles `[✓]`/`[ ]`, Enter confirms. All items checked by default. Width: `TERM_COLS - 4`, max 50, min 10. Labels auto-truncate with `...`. Padding uses `printf '%*s'` (not `printf "%-Ns"` which breaks with ANSI).

### spinner.sh — Braille Spinner

```bash
start_spinner "Loading..."
# ... do work ...
stop_spinner
```

Runs in background subshell (`&` + `disown`). Braille frames: `⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏`. `stop_spinner` kills the subshell and clears the line with `\r\033[K`.

### progress.sh — Progress Bar

```bash
progress_bar 3 10 "Deploying..."  # 30%, yellow
```

Uses `#` for filled, `-` for empty (not `█`/`░` which are double-width in some terminals). Color: red (<33%), yellow (33-66%), green (>66%). Width: `TERM_COLS - 20`, max 50, min 10.

### streambox.sh — Live Log Box

```bash
stream_in_box "Title" "/path/to/logfile" command arg1 arg2
```

Draws a titled box with 4 visible lines. Runs command in background, redirects output to logfile. Refreshes box content every 0.3s by tailing the last 4 lines of the logfile. Strips ANSI codes from log content for clean display. Returns command's exit code.

### dashboard.sh — Main Dashboard

Shows project info, platform details, service health box (green/red/gray dots), credential warnings (`! KEY`), and an action menu. Only shows actions that have corresponding hooks (e.g., Rollback only appears if any service has `rollback.sh`).

## Setup Wizard (setup.sh)

7-step interactive flow:

1. **Project location** — path input with platform info display
2. **Stack questions** — conversational menus: database, API, workers, proxy, containers
3. **Project scan** — scans for Dockerfile, docker-compose.yml, package.json, go.mod, Cargo.toml, etc.
4. **Service checklist** — toggle which services to manage
5. **Per-service config** — health check type (HTTP/TCP/Command/None) + credential storage decision
6. **Project name** — confirm or customize
7. **Write config** — generates deploy.json, creates `.muster/hooks/<svc>/deploy.sh` and `health.sh` stubs, updates .gitignore, shows completion summary

Banner box: drawn with `printf '%b'` (not `echo -e`) to handle ANSI codes correctly. Progress bar in banner uses `#`/`-` chars. Phrase/tagline set once per session via `_SETUP_SESSION_PHRASE`. WINCH redraw only during `read` prompts (not during menus — `read -rsn1` not interrupted by SIGWINCH on bash 3.2).

## Deploy Flow (deploy.sh)

1. Load config, determine target (all or specific service)
2. For each service in `deploy_order`:
   a. Show progress bar
   b. Run `deploy.sh` hook inside `stream_in_box` (live log output)
   c. If deploy succeeds, run `health.sh` with spinner
   d. If health fails: menu offers "Continue anyway" / "Rollback" / "Abort"
   e. Rollback runs `rollback.sh` hook if available
3. Show "Deploy complete" on success

## Skills System

Skills are addons installed to `~/.muster/skills/<name>/`. Structure:

```
skill-name/
├── skill.json   ← {"name", "version", "description", "author", "hooks", "requires"}
└── run.sh       ← executable entry point
```

Environment variables passed to run.sh: `MUSTER_PROJECT_DIR`, `MUSTER_CONFIG_FILE`, `MUSTER_SERVICE`, `MUSTER_HOOK`.

Install: `muster skill add <git-url-or-local-path>` — git URLs are cloned, `muster-skill-` prefix stripped. Local paths are copied. Validates `skill.json` exists.

Naming convention: `muster-skill-<name>` for GitHub repos.

## MCP Integration (bin/muster-mcp)

Pure bash MCP stdio transport. Lets LLMs call muster operations via the Model Context Protocol. Requires `jq`.

Runs as a local process — reads JSON-RPC from stdin, writes responses to stdout. Not a network server.

### Configuration

Claude Desktop (`~/Library/Application Support/Claude/claude_desktop_config.json`):
```json
{ "mcpServers": { "muster": { "command": "muster-mcp" } } }
```

### Available Tools

| Tool | Args | Description |
|------|------|-------------|
| `muster_list_services` | `project_dir` | List services with health type and hook availability |
| `muster_status` | `project_dir` | Health check all services (HEALTHY/UNHEALTHY) |
| `muster_deploy` | `project_dir`, `service?` | Deploy all or specific service, verify health |
| `muster_rollback` | `project_dir`, `service` | Rollback a service |
| `muster_logs` | `project_dir`, `service`, `lines?` | Get recent deploy log lines |
| `muster_cleanup` | `project_dir` | Run cleanup hooks, delete old logs |
| `muster_config` | `project_dir` | Return full deploy.json contents |

All tools require `project_dir` — the path to the project containing `deploy.json`. Output is plain text (no ANSI codes).

### Protocol

Implements MCP protocol version `2024-11-05` over stdio. Handles: `initialize`, `notifications/initialized`, `tools/list`, `tools/call`, `ping`. Overrides the utils.sh EXIT trap to prevent ANSI leaking to stdout.

## Bash 3.2 Compatibility Notes

macOS ships bash 3.2. Key constraints:
- No `local -a` for array declaration (use `local arr=()`)
- No namerefs (`local -n`)
- No fractional `read -t` timeout (`-t 0.1` fails, use `-t 1` or `-t 0`)
- No `${var,,}` lowercase — use `tr '[:upper:]' '[:lower:]'`
- `tput sc`/`tput rc` cursor save/restore unreliable — use `tput cuu1` + `tput ed`
- SIGWINCH does NOT interrupt `read -rsn1` — menu redraws must happen after keypress
- `printf '%b'` for ANSI expansion (not `echo -e` when mixing raw escape bytes)
- `printf "%-Ns"` counts ANSI bytes as visible width — compute padding separately with `printf '%*s'`
