#!/usr/bin/env bash
# muster — Universal deploy framework
# https://github.com/ImJustRicky/muster
set -uo pipefail

MUSTER_VERSION="0.3.0"

# Resolve symlinks (macOS bash 3.2 has no readlink -f)
_muster_self="${BASH_SOURCE[0]}"
while [[ -L "$_muster_self" ]]; do
  _muster_dir="$(cd "$(dirname "$_muster_self")" && pwd)"
  _muster_self="$(readlink "$_muster_self")"
  [[ "$_muster_self" != /* ]] && _muster_self="${_muster_dir}/${_muster_self}"
done
MUSTER_ROOT="$(cd "$(dirname "$_muster_self")/.." && pwd)"
unset _muster_self _muster_dir

# ── Fast path: no lib loading needed ──
case "${1:-}" in
  --version|-v)
    echo "v${MUSTER_VERSION}"
    exit 0
    ;;
esac

# ── Load core libraries ──
source "$MUSTER_ROOT/lib/core/colors.sh"
source "$MUSTER_ROOT/lib/core/logger.sh"
source "$MUSTER_ROOT/lib/core/utils.sh"
source "$MUSTER_ROOT/lib/core/config.sh"
source "$MUSTER_ROOT/lib/core/platform.sh"

# ── Route commands ──
case "${1:-}" in
  setup)
    shift
    source "$MUSTER_ROOT/lib/commands/setup.sh"
    cmd_setup "$@"
    ;;
  deploy)
    shift
    source "$MUSTER_ROOT/lib/commands/deploy.sh"
    cmd_deploy "$@"
    ;;
  status)
    source "$MUSTER_ROOT/lib/commands/status.sh"
    cmd_status
    ;;
  logs)
    shift
    source "$MUSTER_ROOT/lib/commands/logs.sh"
    cmd_logs "$@"
    ;;
  rollback)
    shift
    source "$MUSTER_ROOT/lib/commands/rollback.sh"
    cmd_rollback "$@"
    ;;
  cleanup)
    source "$MUSTER_ROOT/lib/commands/cleanup.sh"
    cmd_cleanup
    ;;
  settings)
    shift
    source "$MUSTER_ROOT/lib/commands/settings.sh"
    cmd_settings "$@"
    ;;
  uninstall)
    source "$MUSTER_ROOT/lib/commands/uninstall.sh"
    cmd_uninstall
    ;;
  skill)
    shift
    source "$MUSTER_ROOT/lib/skills/manager.sh"
    cmd_skill "$@"
    ;;
  --help|-h)
    echo -e "${BOLD}muster${RESET} — Universal deploy framework"
    echo ""
    echo "Usage: muster [command]"
    echo ""
    echo "Commands:"
    echo "  (none)      Open the dashboard"
    echo "  setup       Guided setup wizard (or setup --help for flags)"
    echo "  deploy      Deploy services (--dry-run to preview)"
    echo "  status      Check service health"
    echo "  logs        Stream service logs"
    echo "  rollback    Revert last deploy"
    echo "  cleanup     Clean up stuck processes"
    echo "  settings    View and edit project/global settings"
    echo "  uninstall   Remove muster from project"
    echo "  skill       Manage addon skills (add, create, remove, list, run)"
    echo ""
    echo "Options:"
    echo "  -v, --version   Show version"
    echo "  -h, --help      Show this help"
    ;;
  "")
    # Default: open dashboard
    source "$MUSTER_ROOT/lib/tui/dashboard.sh"
    cmd_dashboard
    ;;
  *)
    err "Unknown command: $1"
    echo "Run 'muster --help' for usage."
    exit 1
    ;;
esac
