# Muster — LLM Guide

> Universal deploy framework. Pure bash (3.2+), zero dependencies, modular TUI.

## Quick Reference

```bash
muster setup       # interactive setup wizard (creates deploy.json + hooks)
muster setup --scan                  # non-interactive: auto-detect everything
muster setup --services api,redis    # non-interactive: explicit services
muster setup --force --scan          # overwrite existing deploy.json
muster setup --help                  # show all setup flags
muster             # dashboard (live health + action menu + installed skills)
muster deploy      # deploy all services
muster deploy api  # deploy one service
muster status      # health check all services
muster logs <svc>  # stream logs for a service
muster rollback <svc>  # rollback a service
muster cleanup     # clean stuck processes + old logs
muster settings    # project settings + global muster settings
muster settings --global                  # dump global settings as JSON
muster settings --global color_mode never # set a global setting
muster uninstall   # remove muster from project
muster skill add <url>  # install a skill addon
muster skill list       # list installed skills
muster skill remove <n> # remove a skill
```

## Project Structure

```
muster/
├── bin/muster                     ← entry point (routes commands)
├── bin/muster-mcp                 ← MCP stdio transport (uses shared scanner)
├── lib/core/                      ← config, colors, logger, platform, utils, scanner, credentials
├── lib/tui/                       ← menu, checklist, spinner, progress, streambox, dashboard, order
├── lib/commands/                  ← setup, deploy, status, logs, rollback, cleanup, settings, uninstall
├── lib/skills/manager.sh          ← skill lifecycle (reads name from skill.json)
├── templates/deploy.example.json  ← example config
├── templates/hooks/               ← stack-specific hook templates (k8s, compose, docker, bare)
│   └── {k8s,compose,docker}/infra/ ← infrastructure service variants (pull-only, no build)
└── docs/skills.md                 ← skill authoring guide
```

## Per-Project Structure (generated by setup)

```
your-project/
├── deploy.json        ← config: services, health checks, deploy order
├── .musterignore      ← (optional) patterns to exclude from scanning
└── .muster/
    ├── hooks/<svc>/   ← deploy.sh, health.sh, rollback.sh, logs.sh, cleanup.sh
    └── logs/          ← deploy logs (gitignored)
```

## Global Settings (~/.muster/settings.json)

| Setting | Default | Description |
|---------|---------|-------------|
| `color_mode` | `auto` | `auto`/`always`/`never` |
| `log_retention_days` | `7` | Days to keep deploy logs |
| `default_stack` | `bare` | Default stack for setup |
| `default_health_timeout` | `10` | Health check timeout (seconds) |
| `scanner_exclude` | `[]` | Global patterns to exclude from scanning |
| `update_check` | `on` | Check for updates |

Edit via `muster settings` (TUI) or `muster settings --global <key> <value>` (scripted).

## Config (deploy.json)

Service keys map to hook directories. Health types: `http`, `tcp`, `command`; disabled via `"enabled": false`. `deploy_order` controls sequencing. Credential modes: `off`, `save` (keychain), `session` (memory), `always` (prompt every time) — never stored in config or git. Service keys with hyphens work (jq bracket notation via `_jq_quote()`).

## Setup Wizard

**Interactive (no flags):** Scan-first TUI wizard. Detects project files (including subdirectories: `docker/`, `k8s/`, `deploy/`, `infra/`), identifies stack and services. User confirms/overrides, sets deploy order, configures health + credentials per service. Falls back to manual questions if nothing detected. Warns if deploy.json already exists. Requires a TTY — errors cleanly if stdin is not interactive.

**Non-interactive (flags):** `muster setup --scan` or `muster setup --services api,redis --stack k8s`. Flags: `--path/-p`, `--scan`, `--stack/-s`, `--services`, `--order`, `--health` (repeatable), `--creds` (repeatable), `--name/-n`, `--force/-f` (overwrite existing config). See `muster setup --help`.

Both modes generate real hooks from stack templates. Infrastructure services (redis, postgres, etc.) get pull-only templates (no docker build). Scanner uses `.musterignore` and auto-skips `archived/deprecated/old/backup` directories.

## Bash 3.2 Rules

- No `local -a`, no namerefs, no fractional `read -t`
- Use `printf '%b'` not `echo -e` for ANSI
- Use `printf '%*s'` for padding (not `printf "%-Ns"` with ANSI)
- Use `#`/`-` for progress bars (not `█`/`░`)
- `tput cuu1` + `tput ed` for redraws (no `tput sc/rc`)
- SIGWINCH does not interrupt `read -rsn1` on macOS bash 3.2
- Resolve symlinks in entry points (no `readlink -f` on macOS — use a while loop)

## Editing Guidelines

- All TUI box widths: `W = TERM_COLS - 4`, max 50 (or 56 for banner), min 10
- Colors via variables from `lib/core/colors.sh` (never hardcode escapes)
- Array append: `arr[${#arr[@]}]=value` (not `arr+=()`)
- Test with `bash -n file.sh` for syntax validation
